<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Menu Dinamico</title>
  <link rel="stylesheet" href="stili.css">
</head>
<body>
    <header>
      <h1>Menu Dinamico</h1>
      <div class="user-info">
        <span>Utente: <span id="username">Nome Utente</span></span>
        <a href="/impostazioni">Impostazioni</a>
        <a href="/logout" id="logout">Logout</a> <!-- Aggiungi ID qui -->
      </div>
    </header>
  
    <nav>
      <ul id="menu"></ul>
    </nav>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // Fetch per ottenere i menu principali
        const mainMenuResponse = await fetch('http://localhost:5000/fepadre/get_by_ids?id=4&id=5&id=6&id=7&id=8');
        if (!mainMenuResponse.ok) {
          throw new Error(`HTTP error! Status: ${mainMenuResponse.status}`);
        }
        const mainMenuItems = await mainMenuResponse.json();

        const menuContainer = document.getElementById('menu');

        // Funzione per ottenere il menu a tendina per ogni voce del menu principale
        async function fetchDropdownMenu(menuId) {
          const dropdownMenuResponse = await fetch(`http://localhost:5000/fefigli/get_all?menu_id=${menuId}`);
          if (!dropdownMenuResponse.ok) {
            throw new Error(`HTTP error! Status: ${dropdownMenuResponse.status}`);
          }
          return await dropdownMenuResponse.json();
        }

        // Iterazione su ogni voce del menu principale
        for (let i = 0; i < mainMenuItems.length; i++) {
          const item = mainMenuItems[i];
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = item.link; // Assicurati che 'link' sia il campo corretto dal backend
          const span = document.createElement('span');
          span.className = `icon ${item.icon}`;
          a.appendChild(span);
          a.appendChild(document.createTextNode(item.titolo));

          // Verifica se esiste una tabella figlia associata per creare il dropdown
          if (item.id) {
            const dropdownMenuItems = await fetchDropdownMenu(item.id);
            if (dropdownMenuItems.length > 0) {
              const dropdown = document.createElement('div');
              dropdown.className = 'dropdown';
              const dropdownContent = document.createElement('div');
              dropdownContent.className = 'dropdown-content';

              dropdownMenuItems.forEach(subItem => {
                const subA = document.createElement('a');
                subA.href = subItem.link; // Assicurati che 'link' sia il campo corretto dal backend
                subA.appendChild(document.createTextNode(subItem.titolo));
                dropdownContent.appendChild(subA);
              });

              dropdown.appendChild(a);
              dropdown.appendChild(dropdownContent);
              li.appendChild(dropdown);
            } else {
              li.appendChild(a); // Se non ci sono voci nel dropdown, aggiungi solo il link principale
            }
          } else {
            li.appendChild(a); // Se non c'è un dropdown associato, aggiungi solo il link principale
          }

          menuContainer.appendChild(li);
        }
      } catch (error) {
        console.error('Errore durante il recupero dei dati:', error);
      }

      // Gestione del logout
      const token = localStorage.getItem('jwt');

      // Controlla se il token è presente per verificare se l'utente è loggato
      if (!token) {
          // Se il token non è presente, reindirizza alla pagina di login
          window.location.href = 'login.html';
          return;
      }

      const username = localStorage.getItem('username');
      if (username) {
          document.getElementById('username').textContent = username;
      }

      document.getElementById('logout').addEventListener('click', function(event) {
          event.preventDefault();
          fetch('http://127.0.0.1:5000/utenti/do_logout', {
              method: 'POST',
              headers: {
                  'Authorization': `Bearer ${token}`
              }
          })
          .then(response => {
              if (response.ok) {
                  // Rimuove il token e le informazioni utente da localStorage
                  localStorage.removeItem('jwt');
                  localStorage.removeItem('username');
                  // Redirige alla pagina di login
                  window.location.href = 'login.html';
              } else {
                  throw new Error('Logout fallito');
              }
          })
          .catch(error => {
              console.error('Errore durante il logout:', error);
              alert('Si è verificato un errore durante il logout');
          });
      });
    });
  </script>
</body>
</html>
