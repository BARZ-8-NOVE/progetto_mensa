{% extends "index.html" %}

{% block title %}
Ordini - Gestione Cucina
{% endblock %}
{% block content %}
<h1>Ordini del giorno {{ day }}/{{ month }}/{{ year }}  </h1>

    <!-- Pulsanti di navigazione del giorno -->
    <form method="GET" action="{{ url_for('app_cucina.ordini') }}">
        <input type="hidden" name="servizio" value="{{ request.args.get('servizio', '1') }}">

        <!-- Pulsante giorno precedente -->
        {% set prev_day = day - 1 %}
        {% set prev_month = month %}
        {% set prev_year = year %}
        {% if prev_day < 1 %}
            {% set prev_month = month - 1 %}
            {% if prev_month < 1 %}
                {% set prev_month = 12 %}
                {% set prev_year = year - 1 %}
            {% endif %}
            {% if prev_month in [1, 3, 5, 7, 8, 10, 12] %}
                {% set prev_day = 31 %}
            {% elif prev_month in [4, 6, 9, 11] %}
                {% set prev_day = 30 %}
            {% elif prev_month == 2 %}
                {% if (prev_year % 4 == 0 and prev_year % 100 != 0) or (prev_year % 400 == 0) %}
                    {% set prev_day = 29 %}
                {% else %}
                    {% set prev_day = 28 %}
                {% endif %}
            {% endif %}
        {% endif %}
        <input type="hidden" name="day" value="{{ prev_day }}">
        <input type="hidden" name="month" value="{{ prev_month }}">
        <input type="hidden" name="year" value="{{ prev_year }}">
        <button type="submit">Giorno Precedente</button>
    </form>

    <form method="GET" action="{{ url_for('app_cucina.ordini') }}">
        <input type="hidden" name="servizio" value="{{ request.args.get('servizio', '1') }}">

        <!-- Pulsante giorno successivo -->
        {% set next_day = day + 1 %}
        {% set next_month = month %}
        {% set next_year = year %}
        {% if next_day > 31 %}
            {% set next_day = 1 %}
            {% set next_month = month + 1 %}
            {% if next_month > 12 %}
                {% set next_month = 1 %}
                {% set next_year = year + 1 %}
            {% endif %}
        {% endif %}
        {% if next_month in [1, 3, 5, 7, 8, 10, 12] %}
            {% if next_day > 31 %}
                {% set next_day = 1 %}
                {% set next_month = next_month + 1 %}
                {% if next_month > 12 %}
                    {% set next_month = 1 %}
                    {% set next_year = next_year + 1 %}
                {% endif %}
            {% endif %}
        {% elif next_month in [4, 6, 9, 11] %}
            {% if next_day > 30 %}
                {% set next_day = 1 %}
                {% set next_month = next_month + 1 %}
                {% if next_month > 12 %}
                    {% set next_month = 1 %}
                    {% set next_year = next_year + 1 %}
                {% endif %}
            {% endif %}
        {% elif next_month == 2 %}
            {% if (next_year % 4 == 0 and next_year % 100 != 0) or (next_year % 400 == 0) %}
                {% if next_day > 29 %}
                    {% set next_day = 1 %}
                    {% set next_month = next_month + 1 %}
                    {% if next_month > 12 %}
                        {% set next_month = 1 %}
                        {% set next_year = next_year + 1 %}
                    {% endif %}
                {% endif %}
            {% else %}
                {% if next_day > 28 %}
                    {% set next_day = 1 %}
                    {% set next_month = next_month + 1 %}
                    {% if next_month > 12 %}
                        {% set next_month = 1 %}
                        {% set next_year = next_year + 1 %}
                    {% endif %}
                {% endif %}
            {% endif %}
        {% endif %}
        <input type="hidden" name="day" value="{{ next_day }}">
        <input type="hidden" name="month" value="{{ next_month }}">
        <input type="hidden" name="year" value="{{ next_year }}">
        <button type="submit">Giorno Successivo</button>
    </form>

    <label for="servizio">Filtra per servizio:</label>
    <form method="GET" action="{{ url_for('app_cucina.ordini') }}">
        <input type="hidden" name="day" value="{{ day }}">
        <input type="hidden" name="year" value="{{ year }}">
        <input type="hidden" name="month" value="{{ month }}">
        <select id="servizio" name="servizio" onchange="this.form.submit()">
            {% for servizio in servizio %}
            <option value="{{ servizio.id }}" {% if request.args.get('servizio', '1') == servizio.id|string %}selected{% endif %}>
                {{ servizio.descrizione }}
            </option>
            {% endfor %}
        </select>
    </form>

    <table>
        <thead>
            <thead>
                <tr>
                    <th class="rotated-header"> Reparto</th>
                    {% for scheda in schede_attive %}
                    <th class="rotated-header" style="background-color: {{ scheda.backgroundColor }};">
                        <span>{{ scheda.titolo }}</span>
                    </th>
                    {% endfor %}
                    <th class="rotated-header"> totali reparti</th>
                </tr>
            </thead>
            
        </thead>
        <tbody id="schedeTableBody">
            {% for reparto in reparti %}
            <tr>
                <td>{{ reparto.descrizione }}</td>

                {% for scheda in schede_attive %}
                <td onclick="showForm('{{ ordine_esistente.id }}','{{ servizio_corrente }}', '{{ reparto.id }}', '{{ scheda.id }}')">
                    {{ schede_count[reparto.id][scheda.id] if schede_count[reparto.id] and scheda.id in schede_count[reparto.id] else 0 }}
                </td>
                {% endfor %}
                <td>{{ reparti_totals[reparto.id] }}</td>
            </tr>
            {% endfor %}
            <tr>
                <td>Totali Schede</td>
                {% for scheda in schede_attive %}
                <td>{{ schede_totals[scheda.id] }}</td>
                {% endfor %}
                <td>{{ total_general }}</td>
            </tr>
        </tbody>
    </table>

    <!-- Calendario FullCalendar -->
    <div id="calendar"></div>
</div>

<script>
    function showForm(ordineId, servizioId, repartoId, schedaId) {
        const url = `ordini_schede_piatti/${ordineId}/${servizioId}/${repartoId}/${schedaId}`;
        console.log("Redirecting to URL: " + url);  // Aggiungi questo per vedere l'URL generato
        window.location.href = url;
    }
    
</script>



{% endblock %}
