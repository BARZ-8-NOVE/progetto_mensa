{% extends "index.html" %}

{% block title %}
Calendario Menu - Gestione Cucina
{% endblock %}

{% block content %}
    <h1>Menu del Mese di {{ month_name }} {{ year }}</h1>

    <!-- Pulsanti di navigazione del mese -->
    <form method="GET" action="{{ url_for('app_cucina.menu') }}">
        <input type="hidden" name="tipo_menu" value="{{ request.args.get('tipo_menu', '1') }}">
        <input type="hidden" name="year" value="{{ year if month > 1 else year - 1 }}">
        <input type="hidden" name="month" value="{{ month - 1 if month > 1 else 12 }}">
        <button type="submit">Mese Precedente</button>
    </form>

    <form method="GET" action="{{ url_for('app_cucina.menu') }}">
        <input type="hidden" name="tipo_menu" value="{{ request.args.get('tipo_menu', '1') }}">
        <input type="hidden" name="year" value="{{ year if month < 12 else year + 1 }}">
        <input type="hidden" name="month" value="{{ month + 1 if month < 12 else 1 }}">
        <button type="submit">Mese Successivo</button>
    </form>

    <label for="tipo_menu">Filtra per tipo di menu:</label>
    <form method="GET" action="{{ url_for('app_cucina.menu') }}">
        <input type="hidden" name="year" value="{{ year }}">
        <input type="hidden" name="month" value="{{ month }}">
        <select id="tipo_menu" name="tipo_menu" onchange="this.form.submit()">
            {% for tipo in tipologie_menu %}
            <option value="{{ tipo.id }}" {% if request.args.get('tipo_menu', '1') == tipo.id|string %}selected{% endif %}>
                {{ tipo.descrizione }}
            </option>
            {% endfor %}
        </select>
    </form>

    <table border="1">
        <thead>
            <tr>
                <th>Data</th>
                <th>Pranzo</th>
                <th>Cena</th>
            </tr>
        </thead>
        <tbody>
            {% for week in month_days %}
                {% for day in week %}
                    {% if day != 0 %}
                    <tr>
                        <td>
                            {% set current_date = datetime(year, month, day) %}
                            {{ current_date.strftime('%Y-%m-%d') }} - {{ weekdays[current_date.weekday()] }}
                        </td>
                        {% set current_date_str = current_date.strftime('%Y-%m-%d') %}
                        <td onclick="showMenuForm({{ menu_per_giorno[current_date_str]['Pranzo'] if current_date_str in menu_per_giorno and 'Pranzo' in menu_per_giorno[current_date_str] else 'null' }})">
                            {% if current_date_str in menu_per_giorno and 'Pranzo' in menu_per_giorno[current_date_str] %}
                                {% set pranzo_id = menu_per_giorno[current_date_str].get('Pranzo') %}
                                {% if pranzo_id %}
                                    {% set piatti_by_category = {'Primi': [], 'Secondi': [], 'Contorni': [], 'Dolci': [] } %}
                                    {% set piatti_pranzo = piattimenu.get(pranzo_id, []) %}
                                    {% for piatto in piatti_pranzo %}
                                        {% set associazione = associazione_map.get(piatto.id, {}) %}
                                        {% if associazione.piatto == 1 %}
                                            {% set _ = piatti_by_category['Primi'].append(associazione.preparazione) %}
                                        {% elif associazione.piatto == 2 %}
                                            {% set _ = piatti_by_category['Secondi'].append(associazione.preparazione) %}
                                        {% elif associazione.piatto == 3 %}
                                            {% set _ = piatti_by_category['Contorni'].append(associazione.preparazione) %}
                                        {% elif associazione.piatto == 4 %}
                                            {% set _ = piatti_by_category['Dolci'].append(associazione.preparazione) %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <div class="menu-columns">
                                        <div class="column">
                                            <h4>Primi</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Primi'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="column">
                                            <h4>Secondi</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Secondi'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="column">
                                            <h4>Contorni</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Contorni'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="column">
                                            <h4>Dolci</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Dolci'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                {% else %}
                                    <p>Nessun piatto disponibile</p>
                                {% endif %}
                            {% else %}
                                <p>Nessun servizio disponibile</p>
                            {% endif %}
                        </td>
                        {% set current_date_str = current_date.strftime('%Y-%m-%d') %}
                        <td onclick="showMenuForm({{ menu_per_giorno[current_date_str]['Cena'] if current_date_str in menu_per_giorno and 'Cena' in menu_per_giorno[current_date_str] else 'null' }})">
                            {% if current_date_str in menu_per_giorno and 'Cena' in menu_per_giorno[current_date_str] %}
                                {% set cena_id = menu_per_giorno[current_date_str].get('Cena') %}
                                {% if cena_id %}
                                    {% set piatti_by_category = {'Primi': [], 'Secondi': [], 'Contorni': [], 'Dolci': [] } %}
                                    {% set piatti_cena = piattimenu.get(cena_id, []) %}
                                    {% for piatto in piatti_cena %}
                                        {% set associazione = associazione_map.get(piatto.id, {}) %}
                                        {% if associazione.piatto == 1 %}
                                            {% set _ = piatti_by_category['Primi'].append(associazione.preparazione) %}
                                        {% elif associazione.piatto == 2 %}
                                            {% set _ = piatti_by_category['Secondi'].append(associazione.preparazione) %}
                                        {% elif associazione.piatto == 3 %}
                                            {% set _ = piatti_by_category['Contorni'].append(associazione.preparazione) %}
                                        {% elif associazione.piatto == 4 %}
                                            {% set _ = piatti_by_category['Dolci'].append(associazione.preparazione) %}
                                        {% endif %}
                                    {% endfor %}

                                    <div class="menu-columns">
                                        <div class="column">
                                            <h4>Primi</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Primi'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="column">
                                            <h4>Secondi</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Secondi'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="column">
                                            <h4>Contorni</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Contorni'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="column">
                                            <h4>Dolci</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Dolci'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                {% else %}
                                    <p>Nessun piatto disponibile</p>
                                {% endif %}
                            {% else %}
                                <p>Nessun servizio disponibile</p>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>

    <script>
        function showMenuForm(id_menu) {
            if (id_menu !== 'null') {
                window.location.href = '/app_cucina/menu/dettagli/' + id_menu;
            } else {
                alert('Nessun menu disponibile.');
            }
        }
    </script>
    
    
    
{% endblock %}
