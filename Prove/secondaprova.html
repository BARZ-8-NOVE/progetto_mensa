{% extends "index.html" %}

{% block title %}
Calendario Menu - Gestione Cucina
{% endblock %}

{% block content %}
    <h1>Menu del Mese di {{ month_name }} {{ year }}</h1>

    <!-- Pulsanti di navigazione del mese -->
    <form method="GET" action="{{ url_for('app_cucina.menu') }}">
        <input type="hidden" name="tipo_menu" value="{{ request.args.get('tipo_menu', '1') }}">
        <input type="hidden" name="year" value="{{ year if month > 1 else year - 1 }}">
        <input type="hidden" name="month" value="{{ month - 1 if month > 1 else 12 }}">
        <button type="submit">Mese Precedente</button>
    </form>

    <form method="GET" action="{{ url_for('app_cucina.menu') }}">
        <input type="hidden" name="tipo_menu" value="{{ request.args.get('tipo_menu', '1') }}">
        <input type="hidden" name="year" value="{{ year if month < 12 else year + 1 }}">
        <input type="hidden" name="month" value="{{ month + 1 if month < 12 else 1 }}">
        <button type="submit">Mese Successivo</button>
    </form>

    <label for="tipo_menu">Filtra per tipo di menu:</label>
    <form method="GET" action="{{ url_for('app_cucina.menu') }}">
        <input type="hidden" name="year" value="{{ year }}">
        <input type="hidden" name="month" value="{{ month }}">
        <select id="tipo_menu" name="tipo_menu" onchange="this.form.submit()">
            {% for tipo in tipologie_menu %}
            <option value="{{ tipo.id }}" {% if request.args.get('tipo_menu', '1') == tipo.id|string %}selected{% endif %}>
                {{ tipo.descrizione }}
            </option>
            {% endfor %}
        </select>
    </form>

    <table border="1">
        <thead>
            <tr>
                <th>Data</th>
                <th>Pranzo</th>
                <th>Cena</th>
            </tr>
        </thead>
        <tbody>
            {% for week in month_days %}
                {% for day in week %}
                    {% if day != 0 %}
                    <tr>
                        <td>
                            {% set current_date = datetime(year, month, day) %}
                            {{ current_date.strftime('%Y-%m-%d') }} - {{ weekdays[current_date.weekday()] }}
                        </td>
                        {% set current_date_str = current_date.strftime('%Y-%m-%d') %}
                        <td onclick="showMenuForm({{ menu_per_giorno[current_date_str]['Pranzo'] if current_date_str in menu_per_giorno and 'Pranzo' in menu_per_giorno[current_date_str] else 'null' }})">
                            {% if current_date_str in menu_per_giorno and 'Pranzo' in menu_per_giorno[current_date_str] %}
                                {% set pranzo_id = menu_per_giorno[current_date_str].get('Pranzo') %}
                                {% if pranzo_id %}
                                    {% set piatti_by_category = {'Primi': [], 'Secondi': [], 'Contorni': [], 'Dolci': [] } %}
                                    {% set piatti_pranzo = piattimenu.get(pranzo_id, []) %}
                                    {% for piatto in piatti_pranzo %}
                                        {% set associazione = associazione_map.get(piatto.id, {}) %}
                                        {% if associazione.piatto == 1 %}
                                            {% set _ = piatti_by_category['Primi'].append(associazione.preparazione) %}
                                        {% elif associazione.piatto == 2 %}
                                            {% set _ = piatti_by_category['Secondi'].append(associazione.preparazione) %}
                                        {% elif associazione.piatto == 3 %}
                                            {% set _ = piatti_by_category['Contorni'].append(associazione.preparazione) %}
                                        {% elif associazione.piatto == 4 %}
                                            {% set _ = piatti_by_category['Dolci'].append(associazione.preparazione) %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <div class="menu-columns">
                                        <div class="column">
                                            <h4>Primi</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Primi'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="column">
                                            <h4>Secondi</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Secondi'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="column">
                                            <h4>Contorni</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Contorni'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="column">
                                            <h4>Dolci</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Dolci'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                {% else %}
                                    <p>Nessun piatto disponibile</p>
                                {% endif %}
                            {% else %}
                                <p>Nessun servizio disponibile</p>
                            {% endif %}
                        </td>
                        {% set current_date_str = current_date.strftime('%Y-%m-%d') %}
                        <td onclick="showMenuForm({{ menu_per_giorno[current_date_str]['Cena'] if current_date_str in menu_per_giorno and 'Cena' in menu_per_giorno[current_date_str] else 'null' }})">
                            {% if current_date_str in menu_per_giorno and 'Cena' in menu_per_giorno[current_date_str] %}
                                {% set cena_id = menu_per_giorno[current_date_str].get('Cena') %}
                                {% if cena_id %}
                                    {% set piatti_by_category = {'Primi': [], 'Secondi': [], 'Contorni': [], 'Dolci': [] } %}
                                    {% set piatti_cena = piattimenu.get(cena_id, []) %}
                                    {% for piatto in piatti_cena %}
                                        {% set associazione = associazione_map.get(piatto.id, {}) %}
                                        {% if associazione.piatto == 1 %}
                                            {% set _ = piatti_by_category['Primi'].append(associazione.preparazione) %}
                                        {% elif associazione.piatto == 2 %}
                                            {% set _ = piatti_by_category['Secondi'].append(associazione.preparazione) %}
                                        {% elif associazione.piatto == 3 %}
                                            {% set _ = piatti_by_category['Contorni'].append(associazione.preparazione) %}
                                        {% elif associazione.piatto == 4 %}
                                            {% set _ = piatti_by_category['Dolci'].append(associazione.preparazione) %}
                                        {% endif %}
                                    {% endfor %}

                                    <div class="menu-columns">
                                        <div class="column">
                                            <h4>Primi</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Primi'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="column">
                                            <h4>Secondi</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Secondi'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="column">
                                            <h4>Contorni</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Contorni'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="column">
                                            <h4>Dolci</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Dolci'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                {% else %}
                                    <p>Nessun piatto disponibile</p>
                                {% endif %}
                            {% else %}
                                <p>Nessun servizio disponibile</p>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>

    <!-- Struttura del Modal -->
    <div id="addMenuModal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form id="menuForm" method="POST" enctype="multipart/form-data">
                    <div class="modal-header">
                        <h5 class="modal-title">Modifica Menu</h5>
                        <button type="button" class="close" onclick="closeMenuForm()">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <!-- Bottoni per la selezione della categoria dei piatti -->
                            <div class="col-md-12">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-primary" onclick="filterPiatti(1)">Primi</button>
                                    <button type="button" class="btn btn-primary" onclick="filterPiatti(2)">Secondi</button>
                                    <button type="button" class="btn btn-primary" onclick="filterPiatti(3)">Contorni</button>
                                    <button type="button" class="btn btn-primary" onclick="filterPiatti(4)">Dolci</button>
                                </div>
                            </div>
                            <!-- Lista dei piatti -->
                            <div class="col-md-12">
                                <div id="piatti-list">
                                    <!-- La lista dei piatti verrà popolata dinamicamente -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeMenuForm()">Chiudi</button>
                        <button type="submit" class="btn btn-primary">Salva</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
// Funzione per aprire il popup e caricare i dettagli del menu

const menuPopup = document.getElementById('menu-popup');
const menuDetails = document.getElementById('menu-details');

// Variabile globale per tenere temporaneamente i dati JSON
let menuData = {};

// Funzione per mostrare il modulo del menu
function showMenuForm(menuId) {
    if (!menuId) {
        alert('Nessun servizio disponibile per questa data.');
        return;
    }

    fetch(`set_menu_id/${menuId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json(); // Parso la risposta come JSON
        })
        .then(data => {
            // Debugging: stampa il tipo e il contenuto di `data`
            console.log('Tipo di `data`:', typeof data);
            console.log('Contenuto di `data`:', data);

            // Assumi che `data` contenga `menu_id` e `associazion` (array)
            menuData = data;
            console.log('Dati menu ricevuti:', menuData);

            // Mostra il modulo del menu
            document.getElementById('addMenuModal').style.display = 'block';

            // Imposta i valori nel modulo per il primo elemento dell'array `associazion`
            if (menuData.associazion && Array.isArray(menuData.associazion)) {
                if (menuData.associazion.length > 0) {
                    const firstItem = menuData.associazion[0];
                    
                    // Aggiungi i valori del primo elemento dell'array al modulo
                    document.getElementById('fkPiattoInput').value = firstItem.fkPiatto || '';
                    document.getElementById('fkPreparazioneInput').value = firstItem.fkPreparazione || '';
                    document.getElementById('idInput').value = firstItem.id || '';
                }

                // Esempio di come gestire più elementi
                const ids = menuData.associazion.map(item => item.id).join(', ');
                document.getElementById('idsList').textContent = ids; // Assicurati di avere un elemento con id="idsList"
            } else {
                console.error('La risposta JSON non contiene un array `associazion`:', menuData);
            }
        })
        .catch(error => {
            console.error('Error setting menu ID in session:', error);
        });
}


function closeMenuForm() {
    document.getElementById('addMenuModal').style.display = 'none';
}

function filterPiatti(categoria) {
    fetch(`get_piatti/${categoria}`)
        .then(response => response.json())
        .then(data => {
            const piattiList = document.getElementById('piatti-list');
            piattiList.innerHTML = ''; // Pulisci le opzioni esistenti

            data.forEach(piatto => {
                const isChecked = menuData.associazion && menuData.associazion.some(item => item.fkPiatto === piatto.id);
                
                const div = document.createElement('div');
                div.classList.add('form-check');
                div.innerHTML = `
                    <input type="checkbox" id="piatto-${piatto.id}" name="piatti" value="${piatto.id}" class="form-check-input" ${isChecked ? 'checked' : ''} onchange="loadPreparazioni(${piatto.id}, this)">
                    <label for="piatto-${piatto.id}" class="form-check-label">${piatto.titolo}</label>
                    <select id="preparazioni-${piatto.id}" name="preparazioni-${piatto.id}[]" multiple class="form-control preparazioni-select">
                        <!-- Preparazioni will be loaded here -->
                    </select>
                `;
                piattiList.appendChild(div);
                
            });
        })
        .catch(error => {
            console.error('Error fetching piatti:', error);
        });
}

const preparazioniMap = {{ preparazioni_map | tojson | safe }};

// Funzione per caricare le preparazioni per un piatto selezionato
function loadPreparazioni(piattoId, checkbox) {
    const preparazioniSelect = document.getElementById(`preparazioni-${piattoId}`);
    
    if (checkbox.checked) {
        fetch(`get_preparazioni/${piattoId}`)
            .then(response => response.json())
            .then(data => {
                preparazioniSelect.innerHTML = ''; // Pulisci le preparazioni esistenti
                
                // Trova le preparazioni già selezionate
                const preparazioniSelezionate = menuData.associazion
                    .filter(item => item.fkPiatto === piattoId)
                    .map(item => item.fkPreparazione);

                data.forEach(preparazione => {
                    const preparazioneId = preparazione.fkPreparazione;
                    const option = document.createElement('option');
                    
                    // Usa la mappa per ottenere la descrizione
                    option.value = preparazioneId;
                    option.text = preparazioniMap[preparazioneId] || `Preparazione ${preparazioneId}`; // Fallback in caso di ID non trovato
                    
                    // Seleziona l'opzione se è nelle preparazioni selezionate
                    if (preparazioniSelezionate.includes(preparazioneId)) {
                        option.selected = true;
                    }
                    
                    preparazioniSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error fetching preparazioni:', error);
            });
    } else {
        preparazioniSelect.innerHTML = ''; // Pulisci le preparazioni se la checkbox viene deselezionata
    }
}




// Funzione per inizializzare il filtro piatti alla categoria predefinita
document.addEventListener('DOMContentLoaded', function() {
    filterPiatti(1); // Imposta la categoria predefinita, ad esempio, 1 per "Primi"
});
    </script>
    
    
    
{% endblock %}
