{% extends "index.html" %}

{% block title %}
Calendario Menu - Gestione Cucina
{% endblock %}

{% block content %}
    <h1>Menu del Mese di {{ month_name }} {{ year }}</h1>

    <!-- Pulsanti di navigazione del mese -->
    <form method="GET" action="{{ url_for('app_cucina.menu') }}">
        <input type="hidden" name="tipo_menu" value="{{ request.args.get('tipo_menu', '1') }}">
        <input type="hidden" name="year" value="{{ year if month > 1 else year - 1 }}">
        <input type="hidden" name="month" value="{{ month - 1 if month > 1 else 12 }}">
        <button type="submit">Mese Precedente</button>
    </form>

    <form method="GET" action="{{ url_for('app_cucina.menu') }}">
        <input type="hidden" name="tipo_menu" value="{{ request.args.get('tipo_menu', '1') }}">
        <input type="hidden" name="year" value="{{ year if month < 12 else year + 1 }}">
        <input type="hidden" name="month" value="{{ month + 1 if month < 12 else 1 }}">
        <button type="submit">Mese Successivo</button>
    </form>

    <label for="tipo_menu">Filtra per tipo di menu:</label>
    <form method="GET" action="{{ url_for('app_cucina.menu') }}">
        <input type="hidden" name="year" value="{{ year }}">
        <input type="hidden" name="month" value="{{ month }}">
        <select id="tipo_menu" name="tipo_menu" onchange="this.form.submit()">
            {% for tipo in tipologie_menu %}
            <option value="{{ tipo.id }}" {% if request.args.get('tipo_menu', '1') == tipo.id|string %}selected{% endif %}>
                {{ tipo.descrizione }}
            </option>
            {% endfor %}
        </select>
    </form>

    <table border="1">
        <thead>
            <tr>
                <th>Data</th>
                <th>Pranzo</th>
                <th>Cena</th>
            </tr>
        </thead>
        <tbody>
            {% for week in month_days %}
                {% for day in week %}
                    {% if day != 0 %}
                    <tr>
                        <td>
                            {% set current_date = datetime(year, month, day) %}
                            {{ current_date.strftime('%Y-%m-%d') }} - {{ weekdays[current_date.weekday()] }}
                        </td>
                        {% set current_date_str = current_date.strftime('%Y-%m-%d') %}
                        <td onclick="showMenuForm({{ menu_per_giorno[current_date_str]['Pranzo'] if current_date_str in menu_per_giorno and 'Pranzo' in menu_per_giorno[current_date_str] else 'null' }})">
                            {% if current_date_str in menu_per_giorno and 'Pranzo' in menu_per_giorno[current_date_str] %}
                                {% set pranzo_id = menu_per_giorno[current_date_str].get('Pranzo') %}
                                {% if pranzo_id %}
                                    {% set piatti_by_category = {'Primi': [], 'Secondi': [], 'Contorni': [], 'Dolci': [] } %}
                                    {% set piatti_pranzo = piattimenu.get(pranzo_id, []) %}
                                    {% for piatto in piatti_pranzo %}
                                        {% set associazione = associazione_map.get(piatto.id, {}) %}
                                        {% if associazione.piatto == 1 %}
                                            {% set _ = piatti_by_category['Primi'].append(associazione.preparazione) %}
                                        {% elif associazione.piatto == 2 %}
                                            {% set _ = piatti_by_category['Secondi'].append(associazione.preparazione) %}
                                        {% elif associazione.piatto == 3 %}
                                            {% set _ = piatti_by_category['Contorni'].append(associazione.preparazione) %}
                                        {% elif associazione.piatto == 4 %}
                                            {% set _ = piatti_by_category['Dolci'].append(associazione.preparazione) %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <div class="menu-columns">
                                        <div class="column">
                                            <h4>Primi</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Primi'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="column">
                                            <h4>Secondi</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Secondi'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="column">
                                            <h4>Contorni</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Contorni'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="column">
                                            <h4>Dolci</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Dolci'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                {% else %}
                                    <p>Nessun piatto disponibile</p>
                                {% endif %}
                            {% else %}
                                <p>Nessun servizio disponibile</p>
                            {% endif %}
                        </td>
                        {% set current_date_str = current_date.strftime('%Y-%m-%d') %}
                        <td onclick="showMenuForm({{ menu_per_giorno[current_date_str]['Cena'] if current_date_str in menu_per_giorno and 'Cena' in menu_per_giorno[current_date_str] else 'null' }})">
                            {% if current_date_str in menu_per_giorno and 'Cena' in menu_per_giorno[current_date_str] %}
                                {% set cena_id = menu_per_giorno[current_date_str].get('Cena') %}
                                {% if cena_id %}
                                    {% set piatti_by_category = {'Primi': [], 'Secondi': [], 'Contorni': [], 'Dolci': [] } %}
                                    {% set piatti_cena = piattimenu.get(cena_id, []) %}
                                    {% for piatto in piatti_cena %}
                                        {% set associazione = associazione_map.get(piatto.id, {}) %}
                                        {% if associazione.piatto == 1 %}
                                            {% set _ = piatti_by_category['Primi'].append(associazione.preparazione) %}
                                        {% elif associazione.piatto == 2 %}
                                            {% set _ = piatti_by_category['Secondi'].append(associazione.preparazione) %}
                                        {% elif associazione.piatto == 3 %}
                                            {% set _ = piatti_by_category['Contorni'].append(associazione.preparazione) %}
                                        {% elif associazione.piatto == 4 %}
                                            {% set _ = piatti_by_category['Dolci'].append(associazione.preparazione) %}
                                        {% endif %}
                                    {% endfor %}

                                    <div class="menu-columns">
                                        <div class="column">
                                            <h4>Primi</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Primi'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="column">
                                            <h4>Secondi</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Secondi'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="column">
                                            <h4>Contorni</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Contorni'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="column">
                                            <h4>Dolci</h4>
                                            <ul>
                                                {% for piatto in piatti_by_category['Dolci'] %}
                                                    <li>{{ piatto }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                {% else %}
                                    <p>Nessun piatto disponibile</p>
                                {% endif %}
                            {% else %}
                                <p>Nessun servizio disponibile</p>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>

    <!-- Struttura del Modal -->
    <div id="addMenuModal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form id="menuForm" method="POST" enctype="multipart/form-data">
                    <div class="modal-header">
                        <h5 class="modal-title">Modifica Menu</h5>
                        <button type="button" class="close" onclick="closeMenuForm()">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <!-- Bottoni per la selezione della categoria dei piatti -->
                            <div class="col-md-12">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-primary" onclick="filterPiatti(1)">Primi</button>
                                    <button type="button" class="btn btn-primary" onclick="filterPiatti(2)">Secondi</button>
                                    <button type="button" class="btn btn-primary" onclick="filterPiatti(3)">Contorni</button>
                                    <button type="button" class="btn btn-primary" onclick="filterPiatti(4)">Dolci</button>
                                </div>
                            </div>
                            <!-- Lista dei piatti -->
                            <div class="col-md-12">
                                <div id="piatti-list">
                                    <!-- La lista dei piatti verrà popolata dinamicamente -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeMenuForm()">Chiudi</button>
                        <button type="submit" class="btn btn-primary">Salva</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>


        // Funzione per aprire il popup e caricare i dettagli del menu
        function showMenuForm(menuId) {
            // Verifica se l'ID del menu è valido
            if (!menuId) {
                alert('Nessun servizio disponibile per questa data.');
                return;
            }
    
            // Ottieni il div del popup
            const addMenuModal = document.getElementById('addMenuModal');
            const menuDetails = document.getElementById('piatti-list');
            
            // Pulizia dei dettagli del menu
            menuDetails.innerHTML = '';
    
            // Chiamata per ottenere i dettagli del menu
            fetch(`get_menu_details/${menuId}`)
                .then(response => response.json())
                .then(data => {
                    // Popola il popup con i dati del menu
                    populateMenuDetails(data);
                    
                    // Mostra il popup
                    addMenuModal.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error fetching menu details:', error);
                });
        }
    
        // Funzione per popolare i dettagli del menu nel popup
        function populateMenuDetails(data) {
            const menuDetails = document.getElementById('piatti-list');
            
            // Verifica se ci sono piatti nel menu
            if (data.length === 0) {
                menuDetails.innerHTML = '<p>Nessun piatto disponibile</p>';
                return;
            }
    
            // Popola i piatti
            data.forEach(piatto => {
                const div = document.createElement('div');
                div.classList.add('form-check');
                
                const piattoId = piatto.id;
                div.innerHTML = `
                    <input type="checkbox" id="piatto-${piattoId}" name="piatti" value="${piattoId}" class="form-check-input" onchange="loadPreparazioni(${piattoId}, this)">
                    <label for="piatto-${piattoId}" class="form-check-label">${piatto.titolo}</label>
                    <select id="preparazioni-${piattoId}" name="preparazioni-${piattoId}[]" multiple class="form-control preparazioni-select">
                        <!-- Preparazioni verranno aggiunte dinamicamente -->
                    </select>
                `;
                menuDetails.appendChild(div);
                
                // Aggiungi preparazioni già selezionate, se disponibili
                if (piatto.preparazioni) {
                    const preparazioniSelect = document.getElementById(`preparazioni-${piattoId}`);
                    piatto.preparazioni.forEach(preparazioneId => {
                        const option = document.createElement('option');
                        option.value = preparazioneId;
                        option.text = preparazioniMap[preparazioneId] || `Preparazione ${preparazioneId}`;
                        preparazioniSelect.appendChild(option);
                    });
                }
            });
        }
    
        // Funzione per chiudere il popup
        function closeMenuForm() {
            document.getElementById('addMenuModal').style.display = 'none';
        }
    
        // Funzione per caricare le preparazioni per un piatto selezionato
        function loadPreparazioni(piattoId, checkbox) {
            const preparazioniSelect = document.getElementById(`preparazioni-${piattoId}`);
            
            if (checkbox.checked) {
                fetch(`get_preparazioni/${piattoId}`)
                    .then(response => response.json())
                    .then(data => {
                        preparazioniSelect.innerHTML = ''; // Pulisci le preparazioni esistenti
                        
                        data.forEach(preparazione => {
                            const option = document.createElement('option');
                            const preparazioneId = preparazione.fkPreparazione;
                            
                            // Usa la mappa per ottenere la descrizione
                            option.value = preparazioneId;
                            option.text = preparazioniMap[preparazioneId] || `Preparazione ${preparazioneId}`; // Fallback in caso di ID non trovato
                            
                            preparazioniSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching preparazioni:', error);
                    });
            } else {
                preparazioniSelect.innerHTML = ''; // Pulisci le preparazioni se la checkbox viene deselezionata
            }
        }
    
        // Funzione per filtrare i piatti in base alla categoria
        function filterPiatti(categoria) {
            fetch(`get_piatti/${categoria}`)
                .then(response => response.json())
                .then(data => {
                    const piattiList = document.getElementById('piatti-list');
                    piattiList.innerHTML = ''; // Pulisci le opzioni esistenti
    
                    data.forEach(piatto => {
                        const div = document.createElement('div');
                        div.classList.add('form-check');
                        div.innerHTML = `
                            <input type="checkbox" id="piatto-${piatto.id}" name="piatti" value="${piatto.id}" class="form-check-input" onchange="loadPreparazioni(${piatto.id}, this)">
                            <label for="piatto-${piatto.id}" class="form-check-label">${piatto.titolo}</label>
                            <select id="preparazioni-${piatto.id}" name="preparazioni-${piatto.id}[]" multiple class="form-control preparazioni-select">
                                <!-- Preparazioni verranno aggiunte dinamicamente -->
                            </select>
                        `;
                        piattiList.appendChild(div);
                    });
                })
                .catch(error => {
                    console.error('Error fetching piatti:', error);
                });
        }
    
        const preparazioniMap = {{ preparazioni_map | tojson | safe }};
    
        // Funzione per inizializzare il filtro piatti alla categoria predefinita
        document.addEventListener('DOMContentLoaded', function() {
            filterPiatti(1); // Imposta la categoria predefinita, ad esempio, 1 per "Primi"
        });
    </script>
    
    
    
{% endblock %}
